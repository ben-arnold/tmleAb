---
title: "tmleAb Vignette"
author: "Ben Arnold (benarnold@berkeley.edu)"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_width: 6
    fig_height: 6
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{tmleAb-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

```{r algorithm libraries,include=FALSE}
# load other algorithm packages to clean up the output for agecurveAb(), below
require(randomForest)
require(arm)
require(gam)
require(polspline)
require(glmnet)
require(scales)
```

## Overview

This vignette describes the main functions in the `tmleAb` package. The software is written in [R](http://www.r-project.org) and is developed on [GitHub](http://www.github.com/ben-arnold/tmleAb). We also recommend the free [RStudio](https://www.rstudio.com/) computing environment.

`tmleAb` is first and foremost a convenience wrapper for two related R packages (both required): `SuperLearner` and `tmle` both on the [CRAN repository](https://cran.r-project.org/). Gruber and van der Laan^[Gruber S, van der Laan M. tmle: An R Package for Targeted Maximum Likelihood Estimation. J Stat Softw. 2012;51: 1–35.] provide a helpful overview of the `tmle` package, and the `SuperLearner' [GitHub page](https://github.com/ecpolley/SuperLearner) includes additional resources beyond the R package and the original article^[van der Laan MJ, Polley EC, Hubbard AE. Super Learner. Stat Appl Genet Mol Biol. 2007;6: 1544–6115.].

At this time, there are two main functions in the package that will be most useful (details below):

* `agecurveAb`
    + This function estimates age-dependent antibody curves with ensemble machine learning (super learner algorithm) or using a single method such as splines, locally weighted regression, or even parametric antibody acquisition models.

* `tmleAb`
    + This function uses targeted maximum likelihood estimation (TMLE) to estimate population means or differences in means for antibody measurements using ensemble machine learning to adjust for age and any other covariates that could confound comparisons between groups.

In addition to these functions, the package also includes a number of antibody datasets:

* `garki_sero` Garki Project (Nigeria) malaria IFA serology data
* `miton_malaria` Miton, Haiti malaria (MSP-1) serology data
* `mauke_wb123` Mauke island lymphatic filariasis Wb123 antibody measurements
* `haiti_enterics` Leogane, Haiti enteric pathogen multiplex antibody data
* `usa_enterics` United States enteric pathogen multiplex antibody data

Please see the article _Measuring population changes in infectious disease transmission from quantitative antibody levels_ (Arnold et al. _in review_) for details about the methodology that underlies this software, as well as more information about the included datasets. 

## Istallation and Updates

You can install this package from GitHub using the `devtools` package in R. 
```
library(devtools)
install_github("ben-arnold/tmleAb")
```

The package is fully functional but should be considered a beta version. Check back here for updates!  We have many updated features planned and expect to eventually distribute the package through CRAN in addition to GitHub.  If you use the package and have any comments please send them along -- we'd love to hear from you (email: benarnold@berkeley.edu).

## agecurveAb

The `agecurveAb` function provides a convenient way to estimate an age-dependent antibody curve -- that is, an average antibody level by age in an population. To provide an example of how to use the function, we'll use the [publically available](http://garkiproject.nd.edu) Garki project data, which includes IFA antibody titres to _Plasmodium falciparum_ measured in individuals living in 6 intervention villages and 2 control villages^[Molineaux L, Gramiccia G. The Garki Project [Internet]. World Health Organization; 1980. Available: http://garkiproject.nd.edu/static/documents/garkiproject.pdf] ^[Cornille-Brögger R, Mathews HM, Storey J, Ashkar TS, Brögger S, Molineaux L. Changing patterns in the humoral immune response to malaria before, during, and after the application of control measures: a longitudinal study in the West African savanna. Bull World Health Organ. 1978;56: 579–600.]  A formatted version of the data is included in the package (`?garki_sero`). To simplify the exposition, we will focus only on the data collected in the active intervention period: three measurements took place after 20, 50, and 70 weeks of intervention: 

```{r read data}
# load the package into R
library(tmleAb)
library(SuperLearner)
# load the Garki serology data and subset it to measurement rounds 3-5, ages <20
d <- garki_sero
d <- subset(d,serosvy>=3 & serosvy<=5 & ageyrs<=20)
# further subset the data by intervention group for convenience
dc <- d[d$tr=="Control" ,]
di <- d[d$tr=="Intervention",]
```

### arguments

The `agecurveAb` function has a number of arguments:

* `Y` : Antibody measurement. Must be a numeric vector.

* `Age` : Age of the individual at the time of measurement. Must be a numeric vector.

* `W` : An optional vector, matrix, or data.frame of covariates for each individual used to marginally adjust the curve.

* `id` : An optional cluster or repeated measures id variable. For cross-validation splits, id forces observations in the same cluster or for the same individual to be in the same validation fold.

* `family` : Model family (gaussian for continuous outcomes, binomial for binary outcomes)
    + Note that if `family=binomial` is specified, the curve estimates age-dependent seroprevalence.
    
* `SL.library` : library of algorithms to include in the super learner ensemble. 
    + The default is `c("SL.mean","SL.glm","SL.yman2016","SL.loess", "SL.gam")`, but many others can be included. Use the `listWrappers()` function in the `SuperLearner` package for a full list (or write your own!).
    
* `RFnodesize` : Optional values used to tune minimum node size used in Random Forest
    + If `SL.randomForest` is included in the library, this tuning parameter allows you to select the optimal minimum node size based on cross-validated risk (if unspecified, the default is to search over values from 5,10,...40).

* `gamdf` : Optional values used to tune the degrees of freedom in natural spline smooths
    + If `SL.gam' is included in the library, this tuning parameter allows you to the optimal degrees of freedom for a natural spline smooth based on cross-validated risk (if unspecified, the default is to search over values from 2,3,...10).

### fitting curves

The parameter of interest is $E(Y_{a,x}) = E_W[E(Y|A=a, X=x, W)]$.  Note that at this time, `agecurveAb` does not separately stratify by $X$, and so it functionally estimates $E(Y_{a}) = E_W[E(Y|A=a, W)]$, with stratification by group ($X$) achieved by estimating the curve on the stratified datasets.  

Here is an example of how to fit age-antibody curves for the control  villages in the Garki Project. The code below uses an algorithm library that includes the simple mean, a main terms generalized linear model, an antibody acquistion model proposed by Yman et al^[Yman V, White MT, Rono J, Arcà B, Osier FH, Troye-Blomberg M, et al. Antibody acquisition models: A new tool for serological surveillance of malaria transmission intensity. Sci Rep.; 2016;6: 19472.], generalized additive models with natural splines, and locally weighted regression:
```{r fit EYax int,cache=TRUE}
# list of models and algorithms to include:
mylib <- c("SL.mean","SL.glm","SL.Yman2016","SL.gam","SL.loess")

# Intervention villages (X=1), fitted curve
set.seed(625234)
fit_i <- agecurveAb(Y=log10(di$ifatpftitre+1),Age=di$ageyrs,id=di$id,SL.library=mylib)
```

Since the SuperLearner algorithm splits the data randomly by id for cross-validation, setting a seed before estimation ensures that you obtain perfectly replicated results.  Notice that the function posted a warning because there were 1097 observations with missing antibody and/or age measurements.  The final, printed output from `agecurveAb` is the cross-validated risk of each algorithm included in the library (column 1) along with the weight given to the algorithm in the final prediction (column 2). "Risk" in this sense is not the epidemiologic concept of risk but instead the loss function. For quantitative antibody measurements, the loss function is the mean squared error (MSE) of the predicted antibody levels compared with the actual antibody levels. In this particular example, generalized additive models (GAM) wins the day and is the only algorithm used in the prediction. The weights represent the optimal combination of the algorithm predictions with respect to the cross-validated risk (MSE). Since the algorithm is data-adaptive, the weighting can change depending on the dataset used or the particular mix of models/algorithms included in the library. For example, let's add random forest into the library:

```{r fit EYax int2,cache=TRUE}
mylib2 <- c("SL.mean","SL.glm","SL.Yman2016","SL.gam","SL.loess","SL.randomForest")
set.seed(625234)
fit_i2 <- agecurveAb(Y=log10(di$ifatpftitre+1),Age=di$ageyrs,id=di$id,SL.library=mylib2)
```

With the addition of the new member to the ensemble, GAM still contributes to the super learner prediction, but the optimal combination also includes information from random forest. We have found in practice that highly adaptive algorithms such as random forest or multivariate adaptive regression splines (MARS) tend to produce jagged age-antibody curves, so using flexible but smoother nonparametric algorithms like natural splines can provide consistent curves that are easier to compare across populations.

A similar curve can be fit in the control villages (reverting to the original library that excludes random forest):
```{r fit EYax control,cache=TRUE}
# Control villages (X=0), fitted curve
fit_c <- agecurveAb(Y=log10(dc$ifatpftitre+1),Age=dc$ageyrs,id=dc$id,SL.library=mylib)
```

As with the intervention villages, GAM is given the full weight in the super learner prediction.  This is not at all true in general -- oftentimes the optimal combination of models/algorithms in the library weights many of them in the overall prediction.  The important point is that it is impossible to know ahead of time what the optimal combination would be -- the data-adaptive machine learning provides an automated solution and investigators can remain agnostic about which model/algorithm to rely on in the curve fitting.

### returned values

`agecurveAb` returns a list that includes many of the original arguments passed to the function along with two new prediction objects:

* `pY` : Vector of predicted mean antibody levels for the individual, same length as `Y`. If adjusted by `W`, then `pY` includes the marginally adjusted prediction at Age=a.
* `pYframe` : An object of class data.frame that includes the actual dataset (feature matrix) used for estimation, along with fitted results (`pY`). Note that the estimation dataset excludes any observations with missing values in `Y`, `Age`, `W` (if not NULL), and `id` (if specified). Factors in `W` are converted to design-matrix-style indicator variables. In general, we recommend using this object to plot results.

### visualizing the results

At this time, there is no default plotting method for `agecurveAb` objects (it is on the to-do list). We designed the function output to make plots relatively painless using the `pYframe` results. Simple plots are easy -- for example, compare control and intervention curves (fit above):
```{r plot control and intervention, fig.cap = "**Age-dependent antibody curves in control and intervention villages.**"}
# grab a color blind friendly palette
cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cols <- cbPalette[c(7,6)]
# plot the curves
plot(fit_c$pYframe$Age,fit_c$pYframe$pY,type="l",col=cols[1],
    xlim=c(0,20),xlab="Age, years",
    ylim=c(0,4),ylab="Log10 P. Falciparum IFA antibody titre",
    bty="n",las=1)
lines(fit_i$pYframe$Age,fit_i$pYframe$pY,col=cols[2],lty=2)
legend("topleft",legend=c("Control","Intervention"),col=cols,lty=c(1,2),bty="n",horiz=T)
```

Or compare the different ensemble library fits in the intervention villages, and show the underlying data
```{r plot intervention, fig.cap = "**Age-dependent antibody curves in intervention villages with different ensembles.**"}
# plot the curves
cols <- cbPalette[c(1,7)]
plot(fit_i2$pYframe$Age,fit_i2$pYframe$pY,type="l",col=cols[1],
    xlim=c(0,20),xlab="Age, years",
    ylim=c(0,4),ylab="Log10 P. Falciparum IFA antibody titre",
    bty="n",las=1)
lines(fit_i$pYframe$Age,fit_i$pYframe$pY,col=cols[2],lty=1)
legend("topleft",legend=c("Incl. random forest","Excl. random forest"),col=cols,lty=c(1,1),bty="n",horiz=T)

# add the underlying raw data points as well
library(scales)
points(fit_i$pYframe$Age,fit_i$pYframe$Y,pch=16,cex=0.2,col=alpha("black",alpha=0.5))
```

### marginally adjusting curves for additional covariates

