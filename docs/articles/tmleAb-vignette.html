<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tmleAb vignette • tmleAb</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">tmleAb</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tmleAb-vignette.html">tmleAb vignette</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/ben-arnold/tmleAb">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>tmleAb vignette</h1>
                        <h4 class="author">vignette for version 0.3.4</h4>
            
            <h4 class="date">2017-12-19</h4>
          </div>

    
    
<div class="contents">
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>This vignette describes the main functions in the <code>tmleAb</code> package. The software is written in <a href="http://www.r-project.org">R</a> and is developed on <a href="http://www.github.com/ben-arnold/tmleAb">GitHub</a>. We also recommend the free <a href="https://www.rstudio.com/">RStudio</a> computing environment.</p>
<p>This package is based on work funded by the National Institute of Allergy and Infectius Diseases grant K01-AI119180.</p>
<p><code>tmleAb</code> is first and foremost a convenience wrapper for two related R packages (both required): <code>SuperLearner</code> and <code>tmle</code> both on the <a href="https://cran.r-project.org/">CRAN repository</a>. Gruber and van der Laan<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> provide a helpful overview of the <code>tmle</code> package, and the <code>SuperLearner</code> <a href="https://github.com/ecpolley/SuperLearner">GitHub page</a> includes additional resources beyond the R package and the original article<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>.</p>
<p>At this time, there are two main functions in the package that will be most useful (details below):</p>
<ul>
<li>
<code>agecurveAb</code>
<ul>
<li>This function estimates age-dependent antibody curves with ensemble machine learning (super learner algorithm) or using a single method such as splines, locally weighted regression, or even parametric antibody acquisition models.</li>
</ul>
</li>
<li>
<code>tmleAb</code>
<ul>
<li>This function uses targeted maximum likelihood estimation (TMLE) to estimate population means or differences in means for antibody measurements using ensemble machine learning to adjust for age and any other covariates that could confound comparisons between groups.</li>
</ul>
</li>
</ul>
<p>In addition to these functions, the package also includes a number of antibody datasets:</p>
<ul>
<li>
<code>garki_sero</code> Garki Project (Nigeria) malaria IFA serology data</li>
<li>
<code>miton_malaria</code> Miton, Haiti malaria (MSP-1) serology data</li>
<li>
<code>mauke_wb123</code> Mauke island lymphatic filariasis Wb123 serology data</li>
<li>
<code>haiti_enterics</code> Leogane, Haiti enteric pathogen multiplex serology data</li>
<li>
<code>usa_enterics</code> United States enteric pathogen multiplex serology data</li>
</ul>
<p>Please see the article <em>Measuring population changes in infectious disease transmission from quantitative antibody levels</em> (Arnold et al. <em>in review</em>) for details about the methodology that underlies this software, as well as more information about the included datasets.</p>
</div>
<div id="istallation-and-updates" class="section level2">
<h2 class="hasAnchor">
<a href="#istallation-and-updates" class="anchor"></a>Istallation and Updates</h2>
<p>You can install this package from GitHub using the <code>devtools</code> package in R.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(devtools)
devtools::<span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"ben-arnold/tmleAb"</span>)</code></pre></div>
<p>The package is in semi-active development. If you use the package and have run into issues and/or have suggestions for improvement feel free to write and we will try our best to respond!</p>
</div>
<div id="agecurveab" class="section level2">
<h2 class="hasAnchor">
<a href="#agecurveab" class="anchor"></a>agecurveAb</h2>
<p>The <code>agecurveAb</code> function provides a convenient way to estimate an age-dependent antibody curve – that is, an average antibody level by age in an population. To provide an example of how to use the function, we’ll use the <a href="http://garkiproject.nd.edu">publically available</a> Garki project data, which includes IFA antibody titres to <em>Plasmodium falciparum</em> measured in individuals living in 6 intervention villages and 2 control villages<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> <a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a> A formatted version of the data is included in the package (<code><a href="../reference/garki_sero.html">?garki_sero</a></code>). To simplify the exposition, we will focus only on the data collected in the active intervention period: three measurements took place after 20, 50, and 70 weeks of intervention:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load the package into R</span>
<span class="kw">library</span>(tmleAb)</code></pre></div>
<pre><code>## Welcome to the tmleAb package
## Targeted maximum likelihood estimation for antibody measurements.
## (Version 0.3.4, release date 2017-12-19)
## 
## Periodically check for the latest development version using 
## devtools::install_github('ben-arnold/tmleAb')  
## 
## This software is based on work funded by the
## National Institute of Allergy and Infectious Diseases
## grant K01-AI119180</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load the Garki serology data (included in the package)</span>
<span class="kw">data</span>(garki_sero)
<span class="co"># and subset it to measurement rounds 3-5, ages &lt;20, non-missing IFA Pf titres</span>
d &lt;-<span class="st"> </span>garki_sero
d &lt;-<span class="st"> </span><span class="kw">subset</span>(d,serosvy&gt;=<span class="dv">3</span> &amp;<span class="st"> </span>serosvy&lt;=<span class="dv">5</span> &amp;<span class="st"> </span>ageyrs&lt;=<span class="dv">20</span> &amp;<span class="st"> </span>!<span class="kw">is.na</span>(ifatpftitre))
<span class="co"># create a log-transformed version of the IFA titres (add 1 for 0 values)</span>
d$logpftitre &lt;-<span class="st"> </span><span class="kw">log10</span>(d$ifatpftitre<span class="dv">+1</span>)
<span class="co"># further subset the data by intervention group for convenience</span>
dc &lt;-<span class="st"> </span>d[d$tr==<span class="st">"Control"</span> ,]
di &lt;-<span class="st"> </span>d[d$tr==<span class="st">"Intervention"</span>,]</code></pre></div>
<div id="arguments" class="section level3">
<h3 class="hasAnchor">
<a href="#arguments" class="anchor"></a>arguments</h3>
<p>The <code>agecurveAb</code> function has a number of arguments, but these are the most important:</p>
<ul>
<li><p><code>Y</code> : Antibody measurement. Must be a numeric vector.</p></li>
<li><p><code>Age</code> : Age of the individual at the time of measurement. Must be a numeric vector.</p></li>
<li><p><code>W</code> : An optional vector, matrix, or data.frame of covariates for each individual used to marginally adjust the curve.</p></li>
<li><p><code>id</code> : An optional cluster or repeated measures id variable. For cross-validation splits, id forces observations in the same cluster or for the same individual to be in the same validation fold.</p></li>
<li><p><code>family</code> : An optional model family for continuous (<code>gaussian</code>) or binary (<code>binomial</code>) outcomes (default is <code>family='gaussian'</code>).</p></li>
<li>
<code>SL.library</code> : library of algorithms to include in the super learner ensemble.
<ul>
<li>The default is <code>c("SL.mean","SL.glm","SL.loess", "SL.gam")</code>, but many others can be included. Use the <code>listWrappers()</code> function in the <code>SuperLearner</code> package for a full list (or write your own!).</li>
</ul>
</li>
</ul>
</div>
<div id="fitting-curves" class="section level3">
<h3 class="hasAnchor">
<a href="#fitting-curves" class="anchor"></a>fitting curves</h3>
<p>The parameter of interest is <span class="math inline">\(E(Y_{a,x}) = E_W[E(Y|A=a, X=x, W)]\)</span>, for age <span class="math inline">\(A\)</span>, group <span class="math inline">\(X\)</span> and covariates <span class="math inline">\(W\)</span>. <strong>Important:</strong> <code>agecurveAb</code> does not separately stratify by group (<span class="math inline">\(X\)</span>), and so it actually estimates <span class="math inline">\(E(Y_{a}) = E_W[E(Y|A=a, W)]\)</span>, with stratification by group (<span class="math inline">\(X\)</span>) achieved by estimating the curve on the stratified datasets.</p>
<p>Here is an example of how to fit separate age-antibody curves for the intervention (<span class="math inline">\(X=1\)</span>) and control (<span class="math inline">\(X=0\)</span>) villages in the Garki Project. The code below uses an algorithm library that includes the simple mean, a main terms generalized linear model, an antibody acquistion model proposed by Yman et al<a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a>, generalized additive models with natural splines, and locally weighted regression:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># list of models and algorithms to include:</span>
mylib &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"SL.mean"</span>,<span class="st">"SL.glm"</span>,<span class="st">"SL.Yman2016"</span>,<span class="st">"SL.gam"</span>,<span class="st">"SL.loess"</span>)

<span class="co"># Intervention villages (X=1), fitted curve</span>
<span class="kw">set.seed</span>(<span class="dv">625234</span>)
fit_i &lt;-<span class="st"> </span><span class="kw"><a href="../reference/agecurveAb.html">agecurveAb</a></span>(<span class="dt">Y=</span>di$logpftitre,<span class="dt">Age=</span>di$ageyrs,<span class="dt">id=</span>di$id,<span class="dt">SL.library=</span>mylib)</code></pre></div>
<pre><code>## 
## Summary of SuperLearner cross validated risk and 
## weights for algorithms included in the library:
## 
##                   CV-Risk Coef
## SL.mean_All     1.3018144    0
## SL.glm_All      0.8459646    0
## SL.Yman2016_All 1.2224624    0
## SL.gam.df10_All 0.6106339    1
## SL.loess_All    0.7025001    0</code></pre>
<p>Since the SuperLearner algorithm splits the data randomly by id for cross-validation, setting a seed before estimation ensures that you obtain perfectly reproducible results. The final, printed output from <code>agecurveAb</code> is the cross-validated risk of each algorithm included in the library (column 1) along with the weight given to the algorithm in the final prediction (column 2). “Risk” in this sense is not the epidemiologic concept of risk but instead the loss function. For quantitative antibody measurements, the loss function is the mean squared error (MSE) of the predicted antibody levels compared with the actual antibody levels.</p>
<p>In this particular example, generalized additive models (GAM) wins the day and is the only algorithm used in the prediction. The weights represent the optimal combination of the algorithm predictions with respect to the cross-validated risk (MSE). Since the algorithm is data-adaptive, the weighting can change depending on the dataset used or the particular mix of models/algorithms included in the library. For example, add random forest into the library:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mylib2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"SL.mean"</span>,<span class="st">"SL.glm"</span>,<span class="st">"SL.Yman2016"</span>,<span class="st">"SL.gam"</span>,<span class="st">"SL.loess"</span>,<span class="st">"SL.randomForest"</span>)
<span class="kw">set.seed</span>(<span class="dv">625234</span>)
fit_i2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/agecurveAb.html">agecurveAb</a></span>(<span class="dt">Y=</span>di$logpftitre,<span class="dt">Age=</span>di$ageyrs,<span class="dt">id=</span>di$id,<span class="dt">SL.library=</span>mylib2)</code></pre></div>
<pre><code>## 
## Summary of SuperLearner cross validated risk and 
## weights for algorithms included in the library:
## 
##                            CV-Risk      Coef
## SL.mean_All              1.3014368 0.0000000
## SL.glm_All               0.8460161 0.0000000
## SL.Yman2016_All          1.2243394 0.0000000
## SL.gam.df10_All          0.6086686 0.4158741
## SL.loess_All             0.7019199 0.0000000
## SL.randomForest.ns40_All 0.5996223 0.5841259</code></pre>
<p>With the addition of the new member to the ensemble, GAM still contributes to the super learner prediction, but the optimal combination also includes information from random forest. We have found in practice that highly adaptive algorithms such as random forest or multivariate adaptive regression splines (MARS) tend to produce jagged age-antibody curves, so using flexible but smoother nonparametric algorithms like natural splines can provide consistent curves that are easier to compare across populations.</p>
<p>A similar curve can be fit in the control villages, <span class="math inline">\(X=0\)</span> (reverting to the original library that excludes random forest):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Control villages (X=0), fitted curve</span>
fit_c &lt;-<span class="st"> </span><span class="kw"><a href="../reference/agecurveAb.html">agecurveAb</a></span>(<span class="dt">Y=</span>dc$logpftitre,<span class="dt">Age=</span>dc$ageyrs,<span class="dt">id=</span>dc$id,<span class="dt">SL.library=</span>mylib)</code></pre></div>
<pre><code>## 
## Summary of SuperLearner cross validated risk and 
## weights for algorithms included in the library:
## 
##                   CV-Risk Coef
## SL.mean_All     0.7534387    0
## SL.glm_All      0.6305149    0
## SL.Yman2016_All 0.6830295    0
## SL.gam.df10_All 0.5053006    1
## SL.loess_All    0.5257182    0</code></pre>
<p>As with the intervention villages, GAM is given the full weight in the super learner prediction. This is not at all true in general – oftentimes the optimal combination of models/algorithms in the library weights many of them in the overall prediction. As we will see below, the age-antibody curves in this population are highly nonlinear, and the only algorithm in this library that can accommodate that is GAM. The important point is that it is impossible to know ahead of time what the optimal combination would be – the data-adaptive machine learning provides an automated solution and investigators can remain agnostic about which model/algorithm to rely on in the curve fitting.</p>
</div>
<div id="returned-values" class="section level3">
<h3 class="hasAnchor">
<a href="#returned-values" class="anchor"></a>returned values</h3>
<p><code>agecurveAb</code> returns a list of objects that includes the input (feature matrix) used for estimation, along with fitted results (<code>pY</code>). Note that the objects returned from <code>agecurveAb</code> <em>exclude</em> observations with missing values in <code>Y</code>, <code>Age</code>, <code>W</code> (if not NULL), and <code>id</code> (if specified). Also note that factors in <code>W</code> are converted to design-matrix-style indicator variables. The objects are sorted by <code>Age</code> to make it easier to plot results. If the call includes covariates <code>W</code>, then <code>pY</code> values are marginally adjusted values at each age <span class="math inline">\(A=a\)</span>.</p>
</div>
<div id="visualizing-the-results" class="section level3">
<h3 class="hasAnchor">
<a href="#visualizing-the-results" class="anchor"></a>visualizing the results</h3>
<p>At this time, there is no default plotting method for <code>agecurveAb</code> objects (it is on the to-do list). But, we designed the function output to make plots relatively painless using the returned results. Simple plots are easy – for example, compare control and intervention curves (fit above):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># grab a color blind friendly palette</span>
cbPalette &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"#000000"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span>)
cols &lt;-<span class="st"> </span>cbPalette[<span class="kw">c</span>(<span class="dv">7</span>,<span class="dv">6</span>)]
<span class="co"># plot the curves</span>
<span class="kw">plot</span>(fit_c$Age,fit_c$pY,<span class="dt">type=</span><span class="st">"l"</span>,<span class="dt">col=</span>cols[<span class="dv">1</span>],
    <span class="dt">main=</span><span class="st">"Age-dependent antibody curves</span><span class="ch">\n</span><span class="st">in control and intervention villages"</span>,
    <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">20</span>),<span class="dt">xlab=</span><span class="st">"Age, years"</span>,
    <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">4</span>),<span class="dt">ylab=</span><span class="st">"Log10 P. Falciparum IFA antibody titre"</span>,
    <span class="dt">bty=</span><span class="st">"n"</span>,<span class="dt">las=</span><span class="dv">1</span>)
<span class="kw">lines</span>(fit_i$Age,fit_i$pY,<span class="dt">col=</span>cols[<span class="dv">2</span>],<span class="dt">lty=</span><span class="dv">2</span>)
<span class="kw">legend</span>(<span class="st">"topleft"</span>,<span class="dt">legend=</span><span class="kw">c</span>(<span class="st">"Control"</span>,<span class="st">"Intervention"</span>),<span class="dt">col=</span>cols,<span class="dt">lty=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="dt">bty=</span><span class="st">"n"</span>,<span class="dt">horiz=</span>T)</code></pre></div>
<p><img src="tmleAb-vignette_files/figure-html/plot%20control%20and%20intervention-1.png" width="672"></p>
<p>Or compare the different ensemble library fits in the intervention villages, and show the underlying data</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot the curves</span>
cols &lt;-<span class="st"> </span>cbPalette[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">7</span>)]
<span class="kw">plot</span>(fit_i2$Age,fit_i2$pY,<span class="dt">type=</span><span class="st">"l"</span>,<span class="dt">col=</span>cols[<span class="dv">1</span>],
    <span class="dt">main=</span><span class="st">"Age-dependent antibody curves</span><span class="ch">\n</span><span class="st">in intervention villages with different ensembles"</span>,
    <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">20</span>),<span class="dt">xlab=</span><span class="st">"Age, years"</span>,
    <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">4</span>),<span class="dt">ylab=</span><span class="st">"Log10 P. Falciparum IFA antibody titre"</span>,
    <span class="dt">bty=</span><span class="st">"n"</span>,<span class="dt">las=</span><span class="dv">1</span>)
<span class="kw">lines</span>(fit_i$Age,fit_i$pY,<span class="dt">col=</span>cols[<span class="dv">2</span>],<span class="dt">lty=</span><span class="dv">1</span>)
<span class="kw">legend</span>(<span class="st">"topleft"</span>,<span class="dt">legend=</span><span class="kw">c</span>(<span class="st">"Incl. random forest"</span>,<span class="st">"Excl. random forest"</span>),<span class="dt">col=</span>cols,<span class="dt">lty=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>),<span class="dt">bty=</span><span class="st">"n"</span>,<span class="dt">horiz=</span>T)

<span class="co"># add the underlying raw data points as well</span>
<span class="kw">library</span>(scales)
<span class="kw">points</span>(fit_i$Age,fit_i$Y,<span class="dt">pch=</span><span class="dv">16</span>,<span class="dt">cex=</span><span class="fl">0.2</span>,<span class="dt">col=</span><span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/alpha">alpha</a></span>(<span class="st">"black"</span>,<span class="dt">alpha=</span><span class="fl">0.5</span>))</code></pre></div>
<p><img src="tmleAb-vignette_files/figure-html/plot%20intervention-1.png" width="672"></p>
<p>In this example, the restricted library closely approximates the more jagged prediction using the larger library that included random forest.</p>
</div>
<div id="marginally-adjusted-curves" class="section level3">
<h3 class="hasAnchor">
<a href="#marginally-adjusted-curves" class="anchor"></a>marginally adjusted curves</h3>
<p>In some settings, such as evaluating programs that were not randomly allocated, you might want to adjust the curves for potentially confounding covariates <code>W</code>. This is straightforward: simply pass a dataframe into the <code>W</code> argument to <code>agecurveAb</code>. For example, we could estimate a marginally adjusted age-antibody curve in the intervention villages, additionally adjusting for sex, season (wet vs. dry), and village:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># fit the age-antibody curve in intervention villages, adjusting for sex, season, and village</span>
fit_iadj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/agecurveAb.html">agecurveAb</a></span>(<span class="dt">Y=</span>di$logpftitre,<span class="dt">Age=</span>di$ageyrs,<span class="dt">id=</span>di$id,
                       <span class="dt">W=</span><span class="kw">subset</span>(di,<span class="dt">select=</span><span class="kw">c</span>(<span class="st">"sex"</span>,<span class="st">"wetseason"</span>,<span class="st">"vname"</span>)),
                       <span class="dt">SL.library=</span>mylib)</code></pre></div>
<pre><code>## 
## Summary of SuperLearner cross validated risk and 
## weights for algorithms included in the library:
## 
##                   CV-Risk Coef
## SL.mean_All     1.3007792    0
## SL.glm_All      0.8344635    0
## SL.Yman2016_All 1.2264498    0
## SL.gam.df10_All 0.5984563    1
## SL.loess_All    0.7045496    0</code></pre>
<p>Although the cross-validated MSE (“risk”) is slightly lower after adjusting for the additional covariates, the mean age-antibody relationship is very similar after adjustment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># compare the results with the unadjusted curve</span>
cols &lt;-<span class="st"> </span>cbPalette[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">7</span>)]
<span class="kw">plot</span>(fit_i$Age,fit_i$pY,<span class="dt">type=</span><span class="st">"l"</span>,<span class="dt">col=</span>cols[<span class="dv">1</span>],
    <span class="dt">main=</span><span class="st">"Unadjusted and marginally adjusted</span><span class="ch">\n</span><span class="st">age-dependent antibody curves in intervention villages"</span>,
    <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">20</span>),<span class="dt">xlab=</span><span class="st">"Age, years"</span>,
    <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">4</span>),<span class="dt">ylab=</span><span class="st">"Log10 P. Falciparum IFA antibody titre"</span>,
    <span class="dt">bty=</span><span class="st">"n"</span>,<span class="dt">las=</span><span class="dv">1</span>)
<span class="kw">lines</span>(fit_iadj$Age,fit_iadj$pY,<span class="dt">col=</span>cols[<span class="dv">2</span>],<span class="dt">lty=</span><span class="dv">1</span>)
<span class="kw">legend</span>(<span class="st">"topleft"</span>,<span class="dt">legend=</span><span class="kw">c</span>(<span class="st">"Unadjusted"</span>,<span class="st">"Adjusted"</span>),<span class="dt">col=</span>cols,<span class="dt">lty=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>),<span class="dt">bty=</span><span class="st">"n"</span>,<span class="dt">horiz=</span>T)</code></pre></div>
<p><img src="tmleAb-vignette_files/figure-html/plot%20intervention%20adj-1.png" width="672"></p>
</div>
</div>
<div id="tmleab" class="section level2">
<h2 class="hasAnchor">
<a href="#tmleab" class="anchor"></a>tmleAb</h2>
<p>Fitting age-antibody curves provides a visual comparison between groups, and <code>tmleAb</code> provides statistical inference for differences between the curves. Group means are a smooth functional of the curve, which allows for asymptotically normally distributed and efficient estimators. One such estimator is targeted maximum likelihood estimation (TMLE)<a href="#fn6" class="footnoteRef" id="fnref6"><sup>6</sup></a> <a href="#fn7" class="footnoteRef" id="fnref7"><sup>7</sup></a>. An important feature of TMLE is that it still provides correct inference while incorporating data-adaptive machine learning in the estimation step.</p>
<p>Here, the parameter of interest is the group mean or difference in means, marginally averaged over age and potentially other covariates: <span class="math inline">\(E(Y_x) = E_{A,W}[E(Y|X=x,A,W)]\)</span>, for age <span class="math inline">\(A\)</span>, group <span class="math inline">\(X\)</span> and covariates <span class="math inline">\(W\)</span>. In fact, estimating <span class="math inline">\(E(Y_x)\)</span> is the same as calculating the area under the age-antibody curves estimated with <code>agecurveAb</code>.</p>
<div id="arguments-1" class="section level3">
<h3 class="hasAnchor">
<a href="#arguments-1" class="anchor"></a>arguments</h3>
<p>The <code>tmleAb</code> function has (by design) almost identical arguments to <code>agecurveAb</code>. These are the most important arguments:</p>
<ul>
<li><p><code>Y</code> : antibody measurement</p></li>
<li><p><code>X</code> : comparison group indicator (must be binary, 0/1) (optional)</p></li>
<li><p><code>W</code> : A matrix of covariates – should probably at minimum include the individual’s age (if available).</p></li>
<li><p><code>id</code> : An optional cluster or repeated measures id variable. For cross-validation splits, id forces observations in the same cluster or for the same individual to be in the same validation fold.</p></li>
<li><p><code>family</code> : An optional model family for continuous (<code>gaussian</code>) or binary (<code>binomial</code>) outcomes (default is <code>family='gaussian'</code>).</p></li>
<li>
<code>SL.library</code> : library of algorithms to include in the super learner ensemble.
<ul>
<li>The default is <code>c("SL.mean","SL.glm","SL.loess", "SL.gam")</code>, but many others can be included. Use the <code>listWrappers()</code> function in the <code>SuperLearner</code> package for a full list (or write your own!).</li>
</ul>
</li>
</ul>
<p>If <code>X=NULL</code>, then <code>tmleAb</code> estimates the marginal mean antibody level along with influence curve based standard errors. If <code>X</code> includes a binary indicator for groups, then <code>tmleAb</code> estimates the difference between groups and provides inference for the difference.</p>
</div>
<div id="estimate-group-means" class="section level3">
<h3 class="hasAnchor">
<a href="#estimate-group-means" class="anchor"></a>estimate group means</h3>
<p>Above in the <code>agecurveAb</code> example, we used the <em>P. falciparum</em> IFA test results in control and intervention villages. Using the notation above, intervention is denoted <span class="math inline">\(X=1\)</span> and control is <span class="math inline">\(X=0\)</span>. Here, we illustrate how to estimate group means and in the next section a difference in means.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># list of models and algorithms to include:</span>
mylib &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"SL.mean"</span>,<span class="st">"SL.glm"</span>,<span class="st">"SL.Yman2016"</span>,<span class="st">"SL.gam"</span>,<span class="st">"SL.loess"</span>)

<span class="co"># Intervention villages (X=1)</span>
<span class="kw">set.seed</span>(<span class="dv">625234</span>)
Wi &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Age=</span>di$ageyrs)
mu_i &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tmleAb.html">tmleAb</a></span>(<span class="dt">Y=</span>di$logpftitre,<span class="dt">X=</span><span class="ot">NULL</span>,<span class="dt">W=</span>Wi,<span class="dt">id=</span>di$id,<span class="dt">SL.library=</span>mylib)</code></pre></div>
<pre><code>##  Population Mean
##    Parameter Estimate:  2.0217
##    Estimated Variance:  0.0018912
##               p-value:  &lt;2e-16
##     95% Conf Interval: (1.9365, 2.107)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Control villages (X=0)</span>
Wc &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Age=</span>dc$ageyrs)
mu_c &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tmleAb.html">tmleAb</a></span>(<span class="dt">Y=</span>dc$logpftitre,<span class="dt">X=</span><span class="ot">NULL</span>,<span class="dt">W=</span>Wc,<span class="dt">id=</span>dc$id,<span class="dt">SL.library=</span>mylib)</code></pre></div>
<pre><code>##  Population Mean
##    Parameter Estimate:  3.0394
##    Estimated Variance:  0.002283
##               p-value:  &lt;2e-16
##     95% Conf Interval: (2.9457, 3.133)</code></pre>
</div>
<div id="estimate-difference-in-means" class="section level3">
<h3 class="hasAnchor">
<a href="#estimate-difference-in-means" class="anchor"></a>estimate difference in means</h3>
<p>The age-antibody curves in control and intervention villages look different, and their means (a summary of the curve) also look different. We can formally test for differences using <code>tmleAb</code>. Note that in the examples above, it was convenient to rely on stratified datasets (<code>di</code>, <code>dc</code>) to separately estimate parameters in control and intervention villages. But, to compare groups you need to have a single dataset, with a binary indicator to identify groups. If you wish to compare many different groups, you can do it by repeating the call to <code>tmleAb</code> using separate indicator variables that contrast each comparison.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># make a binary indicator variable for intervention vs. control</span>
d$tr01 &lt;-<span class="st"> </span><span class="kw">ifelse</span>(d$tr==<span class="st">"Intervention"</span>,<span class="dv">1</span>,<span class="dv">0</span>)
W &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Age=</span>d$ageyrs)
<span class="co"># estimate the difference between groups</span>
psi_diff &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tmleAb.html">tmleAb</a></span>(<span class="dt">Y=</span>d$logpftitre,<span class="dt">X=</span>d$tr01,<span class="dt">W=</span>W,<span class="dt">id=</span>d$id,<span class="dt">SL.library=</span>mylib)</code></pre></div>
<pre><code>##  Additive Effect
##    Parameter Estimate:  -0.94709
##    Estimated Variance:  0.0023054
##               p-value:  &lt;2e-16
##     95% Conf Interval: (-1.0412, -0.85298)</code></pre>
</div>
<div id="returned-values-1" class="section level3">
<h3 class="hasAnchor">
<a href="#returned-values-1" class="anchor"></a>returned values</h3>
<p>The <code>tmleAb</code> function returns a list that includes the following objects:</p>
<ul>
<li>
<code>psi</code> : the mean (or difference) estimated</li>
<li>
<code>se</code> : the standard error of <code>psi</code>, estimated from the influence curve</li>
<li>
<code>lb</code> : the lower 95% confidence interval for <code>psi</code>
</li>
<li>
<code>ub</code> : the upper 95% confidence interval for <code>psi</code>
</li>
<li>
<code>p</code> : a p-value for a test that <code>psi=0</code>
</li>
<li>
<code>tmle_fit</code> : an object of class <code>tmle</code> that includes detailed information about the fit. See the <code>tmle</code> package for details.</li>
</ul>
</div>
</div>
<div id="additional-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#additional-functions" class="anchor"></a>Additional functions</h2>
<p>The <code>tmleAb</code> package includes some additional functions that are listed on the reference page. Most are internal functions that you can ignore, but some are useful. If you wish to evaluate the predictive performance of the Super Learner and its constituent algorithms, then the <code><a href="../reference/cvSLAb.html">cvSLAb()</a></code> function provides a convenient wrapper for the <code>CV.SuperLearner()</code> routine. If you wish to fit age-dependent antibody acquisition models, then the <code><a href="../reference/Yman2016.html">Yman2016()</a></code> function enables this.</p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Gruber S, van der Laan M. tmle: An R Package for Targeted Maximum Likelihood Estimation. J Stat Softw. 2012;51: 1–35.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>van der Laan MJ, Polley EC, Hubbard AE. Super Learner. Stat Appl Genet Mol Biol. 2007;6: 1544–6115.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>Molineaux L, Gramiccia G. The Garki Project [Internet]. World Health Organization; 1980. Available: <a href="http://garkiproject.nd.edu/static/documents/garkiproject.pdf" class="uri">http://garkiproject.nd.edu/static/documents/garkiproject.pdf</a><a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>Cornille-Brögger R, Mathews HM, Storey J, Ashkar TS, Brögger S, Molineaux L. Changing patterns in the humoral immune response to malaria before, during, and after the application of control measures: a longitudinal study in the West African savanna. Bull World Health Organ. 1978;56: 579–600.<a href="#fnref4">↩</a></p></li>
<li id="fn5"><p>Yman V, White MT, Rono J, Arcà B, Osier FH, Troye-Blomberg M, et al. Antibody acquisition models: A new tool for serological surveillance of malaria transmission intensity. Sci Rep.; 2016;6: 19472.<a href="#fnref5">↩</a></p></li>
<li id="fn6"><p>van der Laan MJ, Rubin D. Targeted Maximum Likelihood Learning. Int J Biostat. 2006;2: 1–38.<a href="#fnref6">↩</a></p></li>
<li id="fn7"><p>van der Laan MJ, Rose S. Targeted Learning: Causal Inference for Observational and Experimental Data. Springer Series in Statistics; 2011.<a href="#fnref7">↩</a></p></li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#istallation-and-updates">Istallation and Updates</a></li>
      <li><a href="#agecurveab">agecurveAb</a></li>
      <li><a href="#tmleab">tmleAb</a></li>
      <li><a href="#additional-functions">Additional functions</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Ben Arnold, Kunal Mishra, Mark van der Laan, Alan Hubbard.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
